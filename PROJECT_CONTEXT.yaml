# TipTap React Native POC - Project Context
# Use this file to onboard AI agents for continued development
# Last updated: Session refactored multiple NoteEditors → single MarginEditor

project:
  name: tiptap-rn-poc
  description: |
    A proof-of-concept rich text editor for React Native using TipTap.
    Features margin notes similar to LaTeX \marginpar functionality.
    
    ARCHITECTURE CHANGE: The margin notes panel now uses a SINGLE editor
    instance (MarginEditor) containing all notes as MarginNoteBlock nodes,
    instead of multiple NoteEditor instances (which had performance issues
    due to each WebView consuming 30-50MB memory).
  repository:
    owner: illuminati360
    name: note
    branch: main

# ============================================================================
# ARCHITECTURE OVERVIEW
# ============================================================================

architecture:
  pattern: WebView Bridge
  description: |
    The app uses a hybrid architecture where TipTap editor runs inside a WebView,
    and React Native communicates with it via postMessage/onMessage bridge.
    This approach is necessary because TipTap relies on ProseMirror which requires
    a real DOM environment.

  components:
    react_native_app:
      entry: index.ts
      main_component: App.tsx
      description: Expo-based React Native app that hosts the editor

    editor_web:
      path: editor-web/
      build_tool: Vite with vite-plugin-singlefile
      description: |
        Standalone web build of TipTap editor that gets bundled into a single HTML file.
        This HTML is then embedded in the React Native WebView.
        
        DUAL BUILD: Now builds two separate bundles:
        - index.html / main.ts → Main document editor
        - margin.html / marginEditor.ts → Margin notes editor
      key_files:
        - src/main.ts           # Main editor initialization and message handling
        - src/marginEditor.ts   # Margin notes editor (NEW)
        - index.html
        - margin.html           # (NEW)
        - vite.config.ts
        - vite.margin.config.ts # (NEW) Margin editor build config

    tiptap_extensions:
      path: packages/tiptap-extensions/
      package_name: "@prose/tiptap-extensions"
      description: Custom TipTap Node extensions shared between web and native
      extensions:
        - name: MarginNote
          type: inline node (atom)
          description: |
            Inline anchor badges (numbered circles) that mark positions in the document.
            Each anchor links to a margin note displayed in a side panel.
        - name: MarginNoteBlock
          type: block node (NEW)
          description: |
            Block-level wrapper for each note in the margin editor.
            Contains noteId and noteIndex attributes. Has custom NodeView
            rendering a badge with the note number. Commands:
            - insertMarginNoteBlock(noteId, noteIndex)
            - deleteMarginNoteBlock(noteId)
            - updateMarginNoteBlockIndex(noteId, newIndex)
        - name: NoteHighlight
          type: mark
          description: Highlight text associated with margin notes
        - name: Square
          type: inline node
          description: Decorative square shape
        - name: Circle
          type: inline node
          description: Decorative circle shape
        - name: Flower
          type: inline node
          description: Decorative flower shape

    editor_components:
      path: src/editor/
      description: Platform-specific editor wrappers with unified API
      files:
        - name: TipTapEditor.tsx
          platform: native
          description: WebView-based editor for iOS/Android
        - name: TipTapEditor.web.tsx
          platform: web
          description: Direct TipTap integration for web platform
        - name: MarginEditor.tsx
          platform: native
          description: |
            (NEW) Single WebView-based editor for ALL margin notes.
            Uses MarginNoteBlock extension. Replaced multiple NoteEditors.
        - name: MarginEditor.web.tsx
          platform: web
          description: |
            (NEW) Direct TipTap integration for margin notes on web.
            IMPORTANT: Does NOT clear focusedEditor on blur - this was
            causing toolbar buttons to gray out when clicked.
        - name: AsyncMessages.ts
          description: |
            Manages request/response matching for async WebView communication.
            Solves the problem of correlating responses to specific requests
            when multiple concurrent operations are in flight.
        - name: EditorFocusContext.tsx
          description: |
            React context for tracking which editor (main or margin) has focus.
            Important for applying formatting commands to the correct editor.
            Values: 'main' | 'margin-editor' | null
        - name: editorHtml.ts
          description: Contains the bundled HTML string for main editor WebView
        - name: marginEditorHtml.ts
          description: (NEW) Contains bundled HTML for margin editor WebView
      deleted_files:
        - NoteEditor.tsx      # DELETED - replaced by MarginEditor
        - NoteEditor.web.tsx  # DELETED - replaced by MarginEditor.web

    ui_components:
      path: src/components/
      files:
        - name: MarginNotesPanel.tsx
          description: |
            (REWRITTEN) Side panel displaying margin notes. Now wraps a SINGLE
            MarginEditor instance instead of multiple NoteEditors.
            
            Exposes methods via useImperativeHandle:
            - getMarginEditorRef(): Access to MarginEditor for toolbar commands
            - insertNoteBlock(noteId): Insert new note block
            - deleteNoteBlock(noteId): Delete note block
            - updateNoteIndices(notes): Update all note indices after reorder
            
            Notes are positioned to align with their anchor positions in the
            main editor using absolute positioning.
        - name: ShapeIcons.tsx
          description: React Native SVG icons for shape toolbar buttons

# ============================================================================
# KEY FEATURES IMPLEMENTED
# ============================================================================

features:
  margin_notes:
    status: implemented (REFACTORED)
    description: |
      Academic-style margin notes system similar to LaTeX \marginpar.
      Users can insert numbered anchors in the document that link to
      notes displayed in a right-side panel.
      
      ARCHITECTURE: Uses a SINGLE MarginEditor containing all notes as
      MarginNoteBlock nodes, instead of multiple NoteEditor WebViews.
      This dramatically improves memory usage (one WebView vs many).
    behavior:
      - Anchors display as small numbered circles (1, 2, 3...)
      - Note indices are dynamically recalculated based on document position
      - Notes in the panel try to align vertically with their anchors
      - When anchors are reordered (cut/paste), indices update automatically
      - Single TipTap editor contains all notes as MarginNoteBlock nodes
      - Each MarginNoteBlock has a badge showing note number
      - Focus tracked as 'margin-editor' (single value, not per-note)

  webview_bridge:
    status: implemented
    description: Bidirectional communication between RN and WebView
    message_types:
      outgoing_to_webview:
        - SET_CONTENT: Initialize editor with HTML content
        - GET_CONTENT: Request current editor content
        - TOGGLE_BOLD/ITALIC/etc: Formatting commands
        - INSERT_MARGIN_NOTE: Insert anchor at cursor position
        - DELETE_MARGIN_NOTE: Remove anchor by ID
        - GET_ANCHOR_POSITIONS: Request positions of all margin note anchors
      incoming_from_webview:
        - CONTENT_CHANGED: Editor content was modified
        - SELECTION_CHANGED: Cursor/selection state changed (for toolbar)
        - CONTENT_RESPONSE: Response to GET_CONTENT request
        - ANCHOR_POSITIONS: Positions of margin note anchors
        - READY: Editor finished initializing

  async_message_handling:
    status: implemented
    description: |
      AsyncMessages class provides Promise-based API for WebView calls.
      Each request gets a unique messageId, and responses are matched
      back to their originating Promises. Includes timeout handling.

  platform_specific_exports:
    status: implemented
    description: |
      The src/editor/index.ts uses Platform.select() to export the
      appropriate component (WebView-based or direct TipTap) based
      on the runtime platform.

  focus_management:
    status: implemented (FIXED)
    description: |
      EditorFocusContext tracks whether the main editor or margin editor
      has focus. Toolbar commands are routed to the currently focused editor.
      
      CRITICAL FIX: Do NOT clear focusedEditor on blur. Clicking a toolbar
      button causes the editor to blur momentarily - if we clear focus on
      blur, the toolbar button grays out before the command executes.
      Instead, only set focusedEditor when another editor gains focus.

# ============================================================================
# TECHNICAL DECISIONS & DISCUSSIONS
# ============================================================================

decisions:
  - topic: Why WebView for TipTap?
    decision: Use WebView bridge pattern
    rationale: |
      TipTap is built on ProseMirror which requires a real DOM.
      React Native doesn't have a DOM, so we embed a web-based
      editor in a WebView and communicate via postMessage.
      Alternative approaches like react-native-pell-rich-editor
      were considered but lack TipTap's extensibility.

  - topic: Single HTML file bundling
    decision: Use vite-plugin-singlefile
    rationale: |
      The WebView needs to load the editor. Instead of hosting it
      on a server, we bundle everything (JS, CSS) into a single
      HTML file that can be loaded directly via the source.html prop.

  - topic: Margin note indexing
    decision: Dynamic index calculation based on document order
    rationale: |
      Initially considered storing noteIndex as a fixed attribute,
      but this breaks when users cut/paste content. Instead, we
      query anchor positions from the editor and sort by line number
      to calculate indices dynamically.

  - topic: Single vs Multiple editors for notes
    decision: Single MarginEditor with MarginNoteBlock nodes (REFACTORED)
    rationale: |
      Originally used multiple NoteEditor instances (one per note).
      This had serious performance issues - each WebView consumes
      30-50MB memory. With many notes, memory usage was prohibitive.
      
      Refactored to use a SINGLE MarginEditor containing all notes
      as MarginNoteBlock nodes. This is more efficient and was the
      original design intention.

  - topic: Focus handling on blur
    decision: Do NOT clear focusedEditor on blur (CRITICAL FIX)
    rationale: |
      When clicking a toolbar button, the editor temporarily loses
      focus. If we call setFocusedEditor(null) on blur, the toolbar
      thinks no editor is focused and disables the button before
      the command executes. Instead, only update focusedEditor when
      a specific editor gains focus.

  - topic: LLM for language tutoring
    decision: Gemini 2.5 Flash-Lite
    rationale: |
      For grammar feedback features, Gemini 2.5 Flash-Lite offers
      good quality at low cost. User is learning German and wants
      grammar correction with explanations. Alternatives considered:
      GPT-4o-mini, Claude Haiku. Gemini chosen for cost efficiency.

  - topic: Shared extensions package
    decision: Monorepo with packages/tiptap-extensions
    rationale: |
      The same TipTap extensions need to work in both the web
      bundle (editor-web) and potentially in web platform builds.
      A shared package with proper exports avoids duplication.

# ============================================================================
# DEVELOPMENT WORKFLOW
# ============================================================================

development:
  prerequisites:
    - Node.js (for npm/yarn)
    - Expo CLI
    - iOS Simulator or Android Emulator (for mobile testing)

  setup:
    - command: yarn install
      description: Install all dependencies (uses yarn workspaces)
    - command: cd packages/tiptap-extensions && yarn build
      description: Build the extensions package
    - command: cd editor-web && yarn build
      description: Build the web editor bundle (generates HTML for WebView)

  running:
    - command: yarn start
      description: Start Expo dev server
    - command: yarn ios
      description: Run on iOS simulator
    - command: yarn android
      description: Run on Android emulator
    - command: yarn web
      description: Run web version

  after_editor_changes:
    description: |
      If you modify anything in editor-web/ (including extensions),
      you must rebuild the web bundle and update the HTML exports:
    steps:
      - cd editor-web && npm run build
      - node generateHtmlExport.js
    notes: |
      The build script now produces TWO bundles:
      - dist/index.html → editorHtml.ts (main editor)
      - dist-margin/margin.html → marginEditorHtml.ts (margin editor)

# ============================================================================
# KNOWN ISSUES & TODO
# ============================================================================

known_issues:
  - issue: Editor HTML must be manually copied after rebuild
    severity: minor
    notes: Could automate with a build script

  - issue: Note panel vertical alignment is approximate
    severity: minor
    notes: |
      The LINE_HEIGHT constant (24px) is hardcoded. Should ideally
      be calculated from actual editor line measurements.

future_work:
  - Persist notes to storage/backend
  - Export to LaTeX with \marginpar
  - Collaborative editing support
  - Better keyboard handling on mobile
  - Undo/redo across WebView bridge

# ============================================================================
# FILE REFERENCE QUICK GUIDE
# ============================================================================

quick_reference:
  to_add_new_tiptap_extension:
    - Create extension in packages/tiptap-extensions/src/extensions/
    - Export from packages/tiptap-extensions/src/index.ts
    - Import in editor-web/src/main.ts (or marginEditor.ts) and add to extensions array
    - Rebuild: cd packages/tiptap-extensions && yarn build
    - Rebuild: cd editor-web && npm run build && node generateHtmlExport.js

  to_add_new_toolbar_button:
    - Add button UI in App.tsx toolbar section
    - Handle focus routing (main editor vs margin editor)
    - Add message type in TipTapEditor.tsx (sendMessage function)
    - Handle message in editor-web/src/main.ts (message listener)
    - Add command execution using editor.chain()

  to_modify_margin_notes_behavior:
    - Anchor rendering: packages/tiptap-extensions/src/extensions/MarginNote.ts
    - Note block wrapper: packages/tiptap-extensions/src/extensions/MarginNoteBlock.ts
    - Panel UI: src/components/MarginNotesPanel.tsx
    - Margin editor (web): src/editor/MarginEditor.web.tsx
    - Margin editor (native): src/editor/MarginEditor.tsx
    - Margin editor bundle: editor-web/src/marginEditor.ts
    - Position tracking: editor-web/src/main.ts (getAnchorPositions)
    - State management: App.tsx (marginNotes state, handleAnchorPositions)

# ============================================================================
# DEPENDENCIES SUMMARY
# ============================================================================

dependencies:
  core:
    - expo: ~54.0.31
    - react: 19.1.0
    - react-native: 0.81.5
    - react-native-webview: 13.15.0
    - "@tiptap/core": ^3.14.0
    - "@tiptap/starter-kit": ^3.14.0

  build_tools:
    - vite: ^7.3.0
    - vite-plugin-singlefile: ^2.3.0
    - tsup: ^8.0.0 (for extensions package)
    - typescript: ~5.9.2

# ============================================================================
# CHANGE HISTORY
# ============================================================================

change_history:
  - session: "Single MarginEditor Refactor"
    summary: |
      Major architecture change from multiple NoteEditor instances to
      single MarginEditor with MarginNoteBlock nodes.
    
    files_created:
      - path: packages/tiptap-extensions/src/extensions/MarginNoteBlock.ts
        description: |
          Block-level node extension for wrapping individual notes.
          Has noteId/noteIndex attributes, custom NodeView with badge.
          Commands: insertMarginNoteBlock, deleteMarginNoteBlock, updateMarginNoteBlockIndex
      
      - path: src/editor/MarginEditor.tsx
        description: Native (WebView) margin notes editor
      
      - path: src/editor/MarginEditor.web.tsx
        description: |
          Web platform margin notes editor. Uses direct TipTap.
          Key implementation detail: does NOT call setFocusedEditor(null) on blur.
      
      - path: editor-web/src/marginEditor.ts
        description: |
          WebView bundle for mobile margin editor. Handles:
          - insert-note-block: Inserts block, focuses it, sends note-block-focus
          - delete-note-block: Removes block by noteId
          - update-note-indices: Updates noteIndex attributes
      
      - path: editor-web/margin.html
        description: HTML entry point for margin editor Vite build
      
      - path: editor-web/vite.margin.config.ts
        description: Separate Vite config for margin editor build
      
      - path: src/editor/marginEditorHtml.ts
        description: Generated file containing bundled margin editor HTML

    files_modified:
      - path: packages/tiptap-extensions/src/index.ts
        change: Export MarginNoteBlock extension
      
      - path: editor-web/package.json
        change: |
          Added dual build scripts:
          "build:main": "vite build"
          "build:margin": "vite build --config vite.margin.config.ts"
          "build": "npm run build:main && npm run build:margin"
      
      - path: editor-web/generateHtmlExport.js
        change: Generate both editorHtml.ts and marginEditorHtml.ts
      
      - path: src/editor/TipTapEditor.tsx
        change: Added onFocus/onBlur handlers for focus tracking
      
      - path: editor-web/src/main.ts
        change: Added focus/blur event handlers for native bridge
      
      - path: src/editor/index.ts
        change: Export MarginEditor, removed NoteEditor exports
      
      - path: src/components/MarginNotesPanel.tsx
        change: |
          Complete rewrite. Now wraps single MarginEditor instead of
          multiple NoteEditors. Exposes getMarginEditorRef, insertNoteBlock,
          deleteNoteBlock, updateNoteIndices via useImperativeHandle.
      
      - path: App.tsx
        change: |
          Updated toolbar handlers to route to margin editor:
          notesPanelRef.current?.getMarginEditorRef()?.toggleBold()

    files_deleted:
      - path: src/editor/NoteEditor.tsx
        reason: Replaced by MarginEditor.tsx
      
      - path: src/editor/NoteEditor.web.tsx
        reason: Replaced by MarginEditor.web.tsx

    bugs_fixed:
      - issue: Mobile editor not getting focus
        cause: Missing onFocus/onBlur handlers in native bridge
        fix: Added handlers in TipTapEditor.tsx and main.ts
      
      - issue: Toolbar actions not applying to margin notes
        cause: focusedEditor not being set after note insertion
        fix: |
          In MarginEditor.web.tsx: Call setFocusedEditor('margin-editor')
          after inserting and focusing a note block.
          In marginEditor.ts: Send note-block-focus message after insertion.
      
      - issue: Toolbar buttons graying out when clicked
        cause: setFocusedEditor(null) called on blur
        fix: |
          Removed setFocusedEditor(null) from onBlur handler.
          Clicking toolbar causes momentary blur - if we clear focus,
          toolbar disables before command executes.

# ============================================================================
# CONVERSATION CONTEXT FOR LLM HANDOFF
# ============================================================================

conversation_context:
  summary: |
    User has a TipTap-based React Native rich text editor with margin notes.
    The margin notes feature was refactored from multiple NoteEditor WebViews
    (one per note, ~50MB each) to a single MarginEditor with MarginNoteBlock
    nodes (one WebView for all notes).
    
    Several bugs were fixed related to focus management:
    1. Mobile editor not getting focus - needed bridge handlers
    2. Toolbar not affecting margin notes - needed focusedEditor state
    3. Toolbar buttons disabling on click - don't clear focus on blur
    
    User is planning to add a language tutoring feature using Gemini 2.5
    Flash-Lite for German grammar correction and feedback.

  key_patterns:
    - pattern: Platform-specific components
      description: |
        Use .web.tsx suffix for web platform, .tsx for native.
        Export via Platform.select() in index.ts files.
    
    - pattern: Focus management
      description: |
        EditorFocusContext tracks 'main' | 'margin-editor' | null.
        NEVER clear on blur - only set when another editor gains focus.
    
    - pattern: WebView bridge
      description: |
        Native components use WebView with postMessage/onMessage.
        AsyncMessages class handles request/response correlation.
    
    - pattern: Dual builds
      description: |
        editor-web builds two bundles: main (index.html) and margin (margin.html).
        Both exported to TypeScript string files via generateHtmlExport.js.

  next_steps:
    - Integrate Gemini 2.5 Flash-Lite for grammar feedback
    - Consider persisting notes to storage
    - May need to handle keyboard behavior on mobile
    
  user_context:
    - Learning German, wants grammar tutoring features
    - Familiar with TipTap/ProseMirror concepts
    - Uses macOS, zsh shell
